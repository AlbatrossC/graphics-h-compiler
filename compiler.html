<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Graphics.h Online Compiler | Turbo C++ DOS Emulation</title>
    <!-- Google Fonts - JetBrains Mono for better code readability -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description"
        content="Free graphics.h online compiler for Turbo C++ with DOS emulation. Instantly run and test graphics.h code in your browser.">
    <link rel="canonical" href="https://graphics-h-compiler.vercel.app/compiler.html">

    <!-- Preload Hints for Faster Loading -->
    <link rel="preload" href="https://ltjlklxc9homgiye.public.blob.vercel-storage.com/zips/tc-v1.zip" as="fetch"
        crossorigin="anonymous">
    <link rel="preconnect" href="https://ltjlklxc9homgiye.public.blob.vercel-storage.com">
    <link rel="preconnect" href="https://js-dos.com">

    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="Graphics.h Online Compiler | Turbo C++ DOS Emulation">
    <meta property="og:description"
        content="Run graphics.h code online with Turbo C++ and DOS emulation. No installation, free and browser-based.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://graphics-h-compiler.vercel.app/compiler.html">

    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Graphics.h Online Compiler | Turbo C++ DOS Emulation">
    <meta name="twitter:description"
        content="Free Turbo C++ graphics.h online compiler with DOS emulation. Instantly run graphics.h code in your browser.">
    <meta name="twitter:url" content="https://graphics-h-compiler.vercel.app/compiler.html">

    <!-- Structured Data: SoftwareApplication Schema -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
      "name": "Graphics.h Online Compiler",
      "url": "https://graphics-h-compiler.vercel.app/compiler.html",
      "applicationCategory": "DeveloperApplication",
      "operatingSystem": "Web",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      },
      "description": "Graphics.h Online Compiler is a free Turbo C++ graphics.h compiler with DOS emulation. Instantly run graphics.h code in your browser. Supports Turbo C graphics, DOSBox emulation, and is designed for graphics.h learners.",
      "keywords": "graphics.h online compiler, Turbo C graphics, DOS emulation, Turbo C++ online, graphics.h browser, Turbo C wrapper",
      "softwareVersion": "1.0",
      "author": {
        "@type": "Person",
        "name": "AlbatrossC"
      },
      "publisher": {
        "@type": "Organization",
        "name": "Graphics.h Online Compiler",
        "url": "https://github.com/AlbatrossC/graphics-h-compiler"
      },
      "inLanguage": "en"
    }
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Dark Theme (Default) */
            --vscode-bg: #0a0a0a;
            --vscode-sidebar: #151515;
            --vscode-editor: #0a0a0a;
            --vscode-line-bg: #1a1a1a;
            --vscode-border: #262626;

            /* Green Color Palette - Matching Landing Page */
            --primary: #00ff88;
            --primary-hover: #00cc6a;
            --success: #00ff88;
            --success-hover: #00cc6a;
            --danger: #ff4444;
            --warning: #ffaa00;
            --accent: #00ff88;
            --accent-dark: #00cc6a;

            --text-primary: #fafafa;
            --text-secondary: #a0a0a0;
            --text-muted: #707070;

            --border-color: #262626;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
        }

        /* Light Theme */
        [data-theme="light"] {
            --vscode-bg: #fafafa;
            --vscode-sidebar: #f5f5f5;
            --vscode-editor: #ffffff;
            --vscode-line-bg: #f0f0f0;
            --vscode-border: #e0e0e0;

            /* Green Color Palette for Light Theme */
            --primary: #00cc6a;
            --primary-hover: #00b35c;
            --success: #00cc6a;
            --success-hover: #00b35c;
            --danger: #dc2626;
            --warning: #ca8a04;
            --accent: #00cc6a;
            --accent-dark: #00b35c;

            --text-primary: #0a0a0a;
            --text-secondary: #606060;
            --text-muted: #808080;

            --border-color: #e0e0e0;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--vscode-bg);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Header */
        header {
            background: var(--vscode-sidebar);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 100;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.625rem 1.25rem;
            gap: 1rem;
        }

        .header-left,
        .header-right {
            display: flex;
            align-items: center;
            gap: 0.625rem;
        }

        .header-center {
            flex: 1;
            text-align: center;
        }

        .logo {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            letter-spacing: -0.02em;
            transition: color 0.3s ease;
        }

        .logo-mobile {
            display: none;
        }

        .logo-highlight {
            color: var(--primary);
            transition: color 0.3s ease;
        }

        /* Theme Toggle Button */
        .theme-toggle {
            height: 34px;
            width: 34px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
            border: 1px solid var(--border-color);
            cursor: pointer;
            background: var(--vscode-sidebar);
            color: var(--text-primary);
            padding: 0;
        }

        .theme-toggle:hover {
            background: var(--vscode-line-bg);
            border-color: var(--primary);
            color: var(--primary);
            transform: translateY(-1px);
        }

        .theme-toggle svg {
            width: 17px;
            height: 17px;
        }

        /* Consistent Button Sizes - Slightly Smaller with Smooth Curves */
        .btn,
        .icon-btn,
        .demo-dropdown,
        .save-indicator {
            height: 34px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
            border: 1px solid var(--border-color);
            cursor: pointer;
            background: var(--vscode-sidebar);
            color: var(--text-primary);
        }

        .btn {
            padding: 0 14px;
            gap: 7px;
        }

        .btn svg {
            width: 15px;
            height: 15px;
        }

        .btn-primary {
            background: var(--primary);
            color: #0a0a0a;
            border-color: var(--primary);
            font-weight: 700;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-hover);
            border-color: var(--primary-hover);
            transform: translateY(-1px);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--vscode-sidebar);
            border-color: var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--vscode-line-bg);
            border-color: var(--primary);
        }

        /* Home Button - Same as Run Button (Primary Style) */
        .btn-home {
            background: var(--primary);
            color: #0a0a0a;
            border-color: var(--primary);
            font-weight: 700;
        }

        .btn-home:hover {
            background: var(--primary-hover);
            border-color: var(--primary-hover);
            transform: translateY(-1px);
        }

        .btn-success {
            background: var(--success);
            color: #0a0a0a;
            border-color: var(--success);
            font-weight: 700;
        }

        .btn-success:hover {
            background: var(--success-hover);
            border-color: var(--success-hover);
            transform: translateY(-1px);
        }

        .icon-btn {
            width: 34px;
            padding: 0;
        }

        .icon-btn svg {
            width: 17px;
            height: 17px;
        }

        .icon-btn:hover {
            background: var(--vscode-line-bg);
            border-color: var(--primary);
            color: var(--primary);
            transform: translateY(-1px);
        }

        /* Demo Selector */
        .demo-selector {
            display: flex;
            align-items: center;
            gap: 0.625rem;
        }

        .demo-selector label {
            font-size: 0.875rem;
            font-weight: 700;
            color: var(--primary);
            transition: color 0.3s ease;
        }

        .demo-dropdown {
            padding: 0 12px;
            min-width: 190px;
            cursor: pointer;
            background: var(--vscode-sidebar);
            color: var(--text-primary);
            border-color: var(--border-color);
            font-weight: 500;
        }

        .demo-dropdown:hover {
            background: var(--vscode-line-bg);
            border-color: var(--primary);
            transform: translateY(-1px);
        }

        .demo-dropdown:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 255, 136, 0.2);
        }

        /* Status Indicators */
        .save-indicator {
            padding: 0 11px;
            gap: 7px;
            font-size: 0.8125rem;
            cursor: default;
        }

        .save-indicator.saved {
            background: rgba(0, 255, 136, 0.15);
            border-color: rgba(0, 255, 136, 0.3);
            color: var(--success);
        }

        [data-theme="light"] .save-indicator.saved {
            background: rgba(0, 204, 106, 0.1);
            border-color: rgba(0, 204, 106, 0.3);
        }

        /* Light Theme - Stronger Borders */
        [data-theme="light"] header {
            border-bottom: 2px solid var(--border-color);
        }

        [data-theme="light"] .panel-header {
            border-bottom: 2px solid var(--border-color);
        }

        [data-theme="light"] .editor-footer {
            border-top: 2px solid var(--border-color);
        }

        [data-theme="light"] #editor-wrapper,
        [data-theme="light"] #terminal-wrapper {
            border: 2px solid var(--border-color);
        }

        [data-theme="light"] #editor-wrapper {
            border-right: 2px solid var(--border-color);
        }

        [data-theme="light"] .btn,
        [data-theme="light"] .icon-btn,
        [data-theme="light"] .demo-dropdown,
        [data-theme="light"] .save-indicator,
        [data-theme="light"] .theme-toggle {
            border: 2px solid var(--border-color);
        }

        [data-theme="light"] .blocker-message {
            border: 3px solid var(--primary);
        }

        .save-indicator svg {
            width: 13px;
            height: 13px;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        /* Workspace */
        #workspace {
            display: flex;
            height: calc(100vh - 56px);
            gap: 0;
            overflow: hidden;
        }

        #editor-wrapper,
        #terminal-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--vscode-editor);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        #editor-wrapper {
            border-right: 1px solid var(--border-color);
        }

        #editor-wrapper.active {
            border-color: var(--primary);
        }

        #terminal-wrapper.terminal-active {
            border-color: var(--success);
        }

        /* Fullscreen Fix */
        .fullscreen {
            position: fixed !important;
            top: 0;
            left: 0;
            width: 100vw !important;
            height: 100vh !important;
            z-index: 1000;
            flex: none !important;
            border: none !important;
        }

        .hidden {
            display: none !important;
        }

        /* Panel Header */
        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
            background: var(--vscode-sidebar);
            border-bottom: 1px solid var(--border-color);
            min-height: 42px;
            flex-shrink: 0;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .panel-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            font-size: 0.8125rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: color 0.3s ease;
        }

        .panel-icon {
            width: 16px;
            height: 16px;
            color: var(--primary);
            transition: color 0.3s ease;
        }

        .panel-actions {
            display: flex;
            gap: 8px;
        }

        /* Editor */
        #editor {
            flex: 1;
            width: 100%;
            font-size: 14px;
            background: var(--vscode-editor) !important;
            overflow: hidden;
        }

        /* Override Ace Editor default background */
        .ace_editor {
            background: var(--vscode-editor) !important;
        }

        .ace-monokai .ace_gutter {
            background: var(--vscode-sidebar) !important;
            color: var(--text-secondary) !important;
        }

        .ace-monokai .ace_gutter-active-line {
            background: var(--vscode-line-bg) !important;
        }

        /* Light theme Ace editor styles */
        [data-theme="light"] .ace-textmate .ace_gutter {
            background: var(--vscode-sidebar) !important;
            color: var(--text-secondary) !important;
        }

        [data-theme="light"] .ace-textmate .ace_gutter-active-line {
            background: var(--vscode-line-bg) !important;
        }

        .editor-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 14px;
            background: var(--vscode-sidebar);
            border-top: 1px solid var(--border-color);
            font-size: 0.75rem;
            color: var(--text-muted);
            min-height: 32px;
            flex-shrink: 0;
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }

        .editor-mode {
            padding: 3px 10px;
            background: var(--primary);
            color: #0a0a0a;
            border-radius: 6px;
            font-weight: 700;
            font-size: 0.75rem;
            transition: background-color 0.3s ease;
        }

        /* Terminal/Canvas - Fixed */
        #dos-canvas {
            width: 100%;
            height: 100%;
            background: #000;
            cursor: pointer;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            display: block;
        }

        /* Keyboard Blocker */
        .keyboard-blocker {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .keyboard-blocker.active {
            opacity: 1;
            pointer-events: all;
        }

        .blocker-message {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 24px;
            background: var(--vscode-sidebar);
            border: 2px solid var(--primary);
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.9375rem;
            color: var(--text-primary);
            box-shadow: var(--shadow);
            animation: bounce 2s infinite;
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }

        .blocker-message svg {
            width: 22px;
            height: 22px;
            color: var(--primary);
            transition: color 0.3s ease;
        }

        @keyframes bounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-8px);
            }
        }

        /* Loading Overlay */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--vscode-bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
            z-index: 20;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease, background-color 0.3s ease;
        }

        .loading-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .spinner {
            width: 44px;
            height: 44px;
            border: 3px solid rgba(0, 255, 136, 0.3);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            transition: border-color 0.3s ease;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            transition: color 0.3s ease;
        }

        .loading-progress {
            width: 320px;
            height: 4px;
            background: rgba(128, 128, 128, 0.2);
            border-radius: 2px;
            overflow: hidden;
            position: relative;
        }

        .loading-progress-bar {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.3s ease, background-color 0.3s ease;
        }

        /* Mobile Responsive Styles */
        @media (max-width: 1024px) {
            .header-content {
                padding: 0.5rem 0.75rem;
                gap: 0.5rem;
            }

            .logo {
                font-size: 0.875rem;
            }

            .demo-dropdown {
                min-width: 140px;
                font-size: 0.8125rem;
            }
        }

        @media (max-width: 768px) {

            /* Stack workspace vertically on mobile */
            #workspace {
                flex-direction: column;
                height: calc(100vh - 110px);
                /* Account for multi-row header */
            }

            /* Multi-row header for mobile */
            .header-content {
                flex-wrap: wrap;
                padding: 0.5rem;
                gap: 0.5rem;
            }

            /* First row: Home, Logo, Theme */
            .header-left {
                order: 1;
                flex: 0 0 auto;
            }

            .header-center {
                order: 2;
                flex: 1;
                text-align: center;
                min-width: 0;
                overflow: hidden;
            }

            .header-right {
                order: 3;
                flex: 0 0 auto;
                gap: 0.5rem;
            }

            /* Second row: Demo selector and Run button */
            .demo-selector {
                order: 4;
                flex: 1;
                width: 100%;
            }

            .demo-dropdown {
                flex: 1;
                min-width: 0;
                font-size: 0.8125rem;
            }

            /* Hide text on small buttons */
            .btn-text {
                display: none;
            }

            .logo {
                font-size: 0.75rem;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            /* Show shorter mobile title */
            .logo-full {
                display: none;
            }

            .logo-mobile {
                display: inline;
            }

            /* Smaller buttons on mobile */
            .btn,
            .icon-btn,
            .theme-toggle,
            .save-indicator {
                height: 32px;
                font-size: 0.8125rem;
            }

            .icon-btn,
            .theme-toggle {
                width: 32px;
            }

            .btn {
                padding: 0 10px;
                gap: 5px;
            }

            .btn svg {
                width: 14px;
                height: 14px;
            }

            /* Make Run button always visible */
            #run-btn {
                order: 5;
                min-width: 50px;
            }

            /* Hide save indicator on mobile */
            .save-indicator {
                display: none;
            }

            /* Adjust panel headers */
            .panel-header {
                padding: 8px 10px;
            }

            .panel-title {
                font-size: 0.75rem;
            }

            .panel-icon {
                width: 14px;
                height: 14px;
            }

            /* Adjust editor footer */
            .editor-footer {
                padding: 5px 10px;
                font-size: 0.6875rem;
            }

            /* Hide C++ badge on mobile */
            .editor-mode {
                display: none;
            }

            /* Save button next to Run button */
            #save-btn {
                order: 5;
            }

            #run-btn {
                order: 6;
            }

            /* Better touch targets */
            .icon-btn,
            .btn {
                min-height: 44px;
            }

            /* Adjust loading overlay for mobile */
            .loading-progress {
                width: 240px;
            }

            .loading-text {
                font-size: 0.875rem;
            }

            .blocker-message {
                padding: 12px 16px;
                font-size: 0.875rem;
            }

            .blocker-message svg {
                width: 18px;
                height: 18px;
            }
        }

        /* Very small screens */
        @media (max-width: 480px) {
            .header-content {
                padding: 0.375rem;
            }

            .logo {
                font-size: 0.75rem;
            }

            .demo-selector label {
                font-size: 0.75rem;
            }

            .demo-dropdown {
                font-size: 0.75rem;
            }

            .btn,
            .icon-btn,
            .theme-toggle {
                height: 30px;
            }

            .icon-btn,
            .theme-toggle {
                width: 30px;
            }

            #workspace {
                height: calc(100vh - 100px);
            }
        }

        /* Landscape orientation on mobile */
        @media (max-width: 768px) and (orientation: landscape) {
            #workspace {
                flex-direction: row;
                height: calc(100vh - 90px);
            }

            #editor-wrapper {
                border-right: 1px solid var(--border-color);
            }
        }

        /* Output Panel Styles */
        #output-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 50%;
            background: var(--vscode-editor);
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            z-index: 20;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }

        #output-panel.visible {
            transform: translateY(0);
        }

        #output-panel.expanded {
            height: 100%;
        }

        .output-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 16px;
            background: var(--vscode-sidebar);
            border-bottom: 1px solid var(--border-color);
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            flex-shrink: 0;
        }

        .output-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: 'JetBrains Mono', monospace;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .output-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .copy-error-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 6px 14px;
            height: 30px;
            font-size: 0.75rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            background: #ff6b6b;
            color: #0a0a0a;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
        }

        .copy-error-btn:hover {
            background: #ff5252;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 82, 82, 0.4);
        }

        .copy-error-btn.copied {
            background: #4caf50;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.5);
        }

        .copy-error-btn svg {
            width: 14px;
            height: 14px;
        }

        [data-theme="light"] .copy-error-btn {
            background: #ff6b6b;
            box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
        }

        [data-theme="light"] .copy-error-btn:hover {
            box-shadow: 0 4px 12px rgba(255, 82, 82, 0.4);
        }

        [data-theme="light"] .copy-error-btn.copied {
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.5);
        }

        /* Expand Button */
        .expand-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .expand-btn:hover {
            background: var(--vscode-line-bg);
            border-color: var(--primary);
            color: var(--primary);
            transform: translateY(-1px);
        }

        .expand-btn svg {
            width: 14px;
            height: 14px;
            transition: transform 0.2s ease;
        }

        .expand-btn.expanded svg {
            transform: rotate(180deg);
        }

        [data-theme="light"] .expand-btn {
            border: 2px solid var(--border-color);
        }

        .output-content {
            flex: 1;
            padding: 16px 20px;
            font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', 'Monaco', monospace;
            font-size: 1rem;
            line-height: 1.7;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-word;
            color: var(--text-primary);
            background: var(--vscode-editor);
            letter-spacing: 0.02em;
        }

        .output-content::-webkit-scrollbar {
            width: 8px;
        }

        .output-content::-webkit-scrollbar-track {
            background: var(--vscode-sidebar);
        }

        .output-content::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        .output-content::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        .output-error {
            color: var(--danger);
            font-weight: 500;
        }

        .output-success {
            color: var(--success);
        }

        /* Adjust canvas height when panel is open */
        #terminal-wrapper.has-panel #dos-canvas {
            height: 70%;
        }

        /* Scanf Warning Banner */
        .scanf-warning {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #1a1a1a;
            border: 1px solid #ff4444;
            border-radius: 8px;
            padding: 12px 18px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            max-width: 600px;
        }

        .scanf-warning.visible {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }

        .scanf-warning-icon {
            width: 20px;
            height: 20px;
            color: #ff4444;
            flex-shrink: 0;
            animation: pulse-warning 2s ease-in-out infinite;
        }

        @keyframes pulse-warning {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.6;
            }
        }

        .scanf-warning-text {
            font-size: 0.85rem;
            font-weight: 500;
            color: #ff6666;
            line-height: 1.4;
        }

        .scanf-warning-close {
            background: transparent;
            border: none;
            color: #ff6666;
            cursor: pointer;
            padding: 4px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .scanf-warning-close:hover {
            background: rgba(255, 68, 68, 0.2);
            color: #ff4444;
        }

        .scanf-warning-close svg {
            width: 18px;
            height: 18px;
        }

        /* Light theme styles for scanf warning */
        [data-theme="light"] .scanf-warning {
            background: #fafafa;
            border-color: #dc2626;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        [data-theme="light"] .scanf-warning-icon {
            color: #dc2626;
        }

        [data-theme="light"] .scanf-warning-text {
            color: #991b1b;
        }

        [data-theme="light"] .scanf-warning-close {
            color: #b91c1c;
        }

        [data-theme="light"] .scanf-warning-close:hover {
            background: rgba(220, 38, 38, 0.1);
            color: #dc2626;
        }

        /* Mobile responsiveness for scanf warning */
        @media (max-width: 768px) {
            .scanf-warning {
                bottom: 12px;
                left: 10px;
                right: 10px;
                transform: translateX(0) translateY(100px);
                max-width: none;
                width: auto;
                padding: 10px 14px;
                gap: 8px;
            }

            .scanf-warning.visible {
                transform: translateX(0) translateY(0);
            }

            .scanf-warning-icon {
                width: 18px;
                height: 18px;
                flex-shrink: 0;
            }

            .scanf-warning-text {
                font-size: 0.75rem;
                line-height: 1.3;
            }

            .scanf-warning-close {
                padding: 2px;
            }

            .scanf-warning-close svg {
                width: 16px;
                height: 16px;
            }
        }

        /* Extra small screens */
        @media (max-width: 400px) {
            .scanf-warning {
                padding: 8px 12px;
                gap: 6px;
            }

            .scanf-warning-icon {
                width: 16px;
                height: 16px;
            }

            .scanf-warning-text {
                font-size: 0.7rem;
            }
        }
    </style>

    <script src="static/analytics.js" defer></script>
</head>

<body>

    <header>
        <div class="header-content">
            <div class="header-left">
                <button id="back-btn" class="btn btn-home" onclick="window.location.href='index.html'">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" />
                    </svg>
                    <span class="btn-text">Home</span>
                </button>
            </div>

            <div class="header-center">
                <div class="logo">
                    <span class="logo-full">Online <span class="logo-highlight">graphics.h</span> Compiler</span>
                    <span class="logo-mobile"><span class="logo-highlight">graphics.h</span> Compiler</span>
                </div>
            </div>

            <div class="header-right">
                <button id="theme-toggle" class="theme-toggle" title="Toggle Theme">
                    <svg id="theme-icon-dark" viewBox="0 0 24 24" fill="currentColor" style="display: block;">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />
                    </svg>
                    <svg id="theme-icon-light" viewBox="0 0 24 24" fill="currentColor" style="display: none;">
                        <path
                            d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0 .39-.39.39-1.03 0-1.41l-1.06-1.06zm1.06-10.96c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z" />
                    </svg>
                </button>
            </div>

            <div class="demo-selector">
                <label for="demo-select">Demo:</label>
                <select id="demo-select" class="demo-dropdown">
                    <option value="graphics-demo" selected>Graphics Demo</option>
                    <option value="circle-pattern">Circle Pattern</option>
                    <option value="bouncing-ball">Bouncing Ball</option>
                    <option value="shooter-game">Shooter Game</option>
                </select>
            </div>

            <div class="save-indicator" id="save-indicator">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path
                        d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z" />
                </svg>
                <span id="save-text">Not Saved</span>
            </div>

            <button id="save-btn" class="btn btn-success" onclick="saveCode()">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path
                        d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z" />
                </svg>
                <span class="btn-text">Save</span>
            </button>

            <button id="run-btn" class="btn btn-primary" onclick="runProgram()">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M8 5v14l11-7z" />
                </svg>
                <span class="btn-text">Compile and Run</span>
            </button>
        </div>
    </header>

    <div id="workspace">
        <div id="editor-wrapper">
            <div class="panel-header">
                <div class="panel-title">
                    <svg viewBox="0 0 24 24" fill="currentColor" class="panel-icon">
                        <path
                            d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z" />
                    </svg>
                    Source Code Editor
                </div>
                <div class="panel-actions">
                    <button id="clear-btn" class="icon-btn" title="Clear Editor">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
                        </svg>
                    </button>
                    <button id="fullscreen-editor-btn" class="icon-btn" title="Toggle Fullscreen">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z" />
                        </svg>
                    </button>
                </div>
            </div>
            <div id="editor"></div>
            <div class="editor-footer">
                <span class="editor-info" id="editor-info">Lines: 0 | Chars: 0</span>
            </div>
        </div>

        <div id="terminal-wrapper">
            <div class="panel-header">
                <div class="panel-title">
                    <svg viewBox="0 0 24 24" fill="currentColor" class="panel-icon">
                        <path
                            d="M20 4H4c-1.11 0-2 .89-2 2v12c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4V8h16v10z" />
                    </svg>
                    DOS Output
                </div>
                <div class="panel-actions">
                    <button id="fullscreen-terminal-btn" class="icon-btn" title="Toggle Fullscreen">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z" />
                        </svg>
                    </button>
                </div>
            </div>

            <div class="keyboard-blocker" id="keyboard-blocker">
                <div class="blocker-message">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" />
                    </svg>
                    Click to interact with terminal
                </div>
            </div>

            <div class="loading-overlay" id="loading">
                <div class="spinner"></div>
                <div class="loading-text" id="loading-text">Initializing...</div>
                <div class="loading-progress">
                    <div class="loading-progress-bar" id="loading-progress-bar"></div>
                </div>
            </div>

            <canvas id="dos-canvas" tabindex="-1"></canvas>

            <div id="output-panel">
                <div class="output-header">
                    <div class="output-title">
                        <svg viewBox="0 0 24 24" fill="currentColor"
                            style="width: 16px; height: 16px; color: var(--danger);">
                            <path
                                d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z" />
                        </svg>
                        Compilation Errors
                    </div>
                    <div class="output-actions">
                        <button id="copy-error-btn" class="copy-error-btn" title="Copy errors to clipboard">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z" />
                            </svg>
                            <span id="copy-btn-text">Copy Errors</span>
                        </button>
                        <button id="expand-output-btn" class="expand-btn" title="Expand/Collapse panel">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" />
                            </svg>
                        </button>
                        <button id="close-output-btn" class="icon-btn"
                            style="height: 28px; width: 28px; min-height: unset; border: 1px solid var(--border-color); background: transparent; border-radius: 6px;">
                            <svg viewBox="0 0 24 24" fill="currentColor" style="width: 14px; height: 14px;">
                                <path
                                    d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
                            </svg>
                        </button>
                    </div>
                </div>
                <div id="output-content" class="output-content"></div>
            </div>
        </div>
    </div>

    <!-- Scanf Warning Banner -->
    <div id="scanf-warning" class="scanf-warning">
        <svg class="scanf-warning-icon" viewBox="0 0 24 24" fill="currentColor">
            <path
                d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z" />
        </svg>
        <span class="scanf-warning-text">Please hardcode values instead of taking input from the user, as input-based
            programs may not work correctly.</span>
        <button id="scanf-warning-close" class="scanf-warning-close" title="Dismiss">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path
                    d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
            </svg>
        </button>
    </div>

    <script>
        // ==================== THEME TOGGLE ====================

        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);

            // Update Ace editor theme
            if (editor) {
                const aceTheme = newTheme === 'dark' ? 'ace/theme/monokai' : 'ace/theme/textmate';
                editor.setTheme(aceTheme);
            }

            Logger.info(`Theme switched to ${newTheme}`);
        }

        function updateThemeIcon(theme) {
            const darkIcon = document.getElementById('theme-icon-dark');
            const lightIcon = document.getElementById('theme-icon-light');

            if (theme === 'dark') {
                darkIcon.style.display = 'block';
                lightIcon.style.display = 'none';
            } else {
                darkIcon.style.display = 'none';
                lightIcon.style.display = 'block';
            }
        }

        document.getElementById('theme-toggle').addEventListener('click', toggleTheme);

        // Initialize theme on page load
        initializeTheme();

        // ==================== LOGGER ====================
        const Logger = {
            prefix: '[Graphics.h Compiler]',

            info(msg) {
                console.log(`${this.prefix} ${msg}`);
            },

            success(msg) {
                console.log(`${this.prefix} ✓ ${msg}`);
            },

            error(msg, err) {
                console.error(`${this.prefix} ✗ ${msg}`, err || '');
            },

            warn(msg) {
                console.warn(`${this.prefix} ⚠ ${msg}`);
            }
        };

        // ==================== GLOBAL STATE ====================
        let dosInstance = null;
        let terminalFocused = false;
        let editor = null;
        let currentDemo = 'graphics-demo';
        let lastLoadedDemo = ''; // Track last loaded demo
        let scriptsLoaded = {
            jsdos: false,
            ace: false,
            aceMode: false,
            aceTheme: false
        };

        // Demo files configuration - FETCHING FROM BLOB STORAGE
        const DEMO_FILES = {
            'graphics-demo': 'https://ltjlklxc9homgiye.public.blob.vercel-storage.com/demo/graphics_demo.cpp',
            'circle-pattern': 'https://ltjlklxc9homgiye.public.blob.vercel-storage.com/demo/circle-pattern.cpp',
            'bouncing-ball': 'https://ltjlklxc9homgiye.public.blob.vercel-storage.com/demo/bouncing-ball.cpp',
            'shooter-game': 'https://ltjlklxc9homgiye.public.blob.vercel-storage.com/demo/shooter-game.cpp'
        };

        // TC.ZIP URL - FETCHING FROM BLOB STORAGE
        const TC_ZIP_URL = 'https://ltjlklxc9homgiye.public.blob.vercel-storage.com/zips/tc-v1.zip';

        // ==================== CACHING SYSTEM ====================
        const CACHE_CONFIG = {
            TC_ZIP_CACHE_KEY: 'tc_zip_cache',
            TC_ZIP_VERSION: 'tc-v1',
            DEMO_CACHE_PREFIX: 'demo_cache_',
            CACHE_TTL: 7 * 24 * 60 * 60 * 1000, // 7 days in ms
            DB_NAME: 'GraphicsHCompilerCache',
            DB_VERSION: 1,
            STORE_NAME: 'files'
        };

        // IndexedDB for large file caching (TC ZIP)
        let cacheAvailable = true; // Flag to prevent repeated IndexedDB retries

        class CacheDB {
            static db = null;

            static async open() {
                if (!cacheAvailable) return null; // Don't retry if previously failed
                if (this.db) return this.db;

                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(CACHE_CONFIG.DB_NAME, CACHE_CONFIG.DB_VERSION);

                    request.onerror = () => {
                        cacheAvailable = false; // Mark cache as unavailable
                        Logger.warn('IndexedDB not available, caching disabled');
                        resolve(null);
                    };

                    request.onsuccess = () => {
                        this.db = request.result;
                        resolve(this.db);
                    };

                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains(CACHE_CONFIG.STORE_NAME)) {
                            db.createObjectStore(CACHE_CONFIG.STORE_NAME, { keyPath: 'key' });
                        }
                    };
                });
            }

            static async get(key) {
                const db = await this.open();
                if (!db) return null;

                return new Promise((resolve) => {
                    try {
                        const transaction = db.transaction(CACHE_CONFIG.STORE_NAME, 'readonly');
                        const store = transaction.objectStore(CACHE_CONFIG.STORE_NAME);
                        const request = store.get(key);

                        request.onsuccess = () => {
                            const result = request.result;
                            if (result && result.timestamp) {
                                const age = Date.now() - result.timestamp;
                                if (age < CACHE_CONFIG.CACHE_TTL) {
                                    resolve(result.data);
                                    return;
                                }
                            }
                            resolve(null);
                        };

                        request.onerror = () => resolve(null);
                    } catch (e) {
                        resolve(null);
                    }
                });
            }

            static async set(key, data) {
                const db = await this.open();
                if (!db) return false;

                return new Promise((resolve) => {
                    try {
                        const transaction = db.transaction(CACHE_CONFIG.STORE_NAME, 'readwrite');
                        const store = transaction.objectStore(CACHE_CONFIG.STORE_NAME);
                        const request = store.put({
                            key: key,
                            data: data,
                            timestamp: Date.now()
                        });

                        request.onsuccess = () => resolve(true);
                        request.onerror = () => resolve(false);
                    } catch (e) {
                        resolve(false);
                    }
                });
            }
        }

        // Demo file cache using localStorage
        const DemoCache = {
            get(demoKey) {
                try {
                    const cacheKey = CACHE_CONFIG.DEMO_CACHE_PREFIX + demoKey;
                    const cached = localStorage.getItem(cacheKey);
                    if (!cached) return null;

                    const { code, timestamp } = JSON.parse(cached);
                    const age = Date.now() - timestamp;

                    if (age < CACHE_CONFIG.CACHE_TTL) {
                        return code;
                    }

                    // Expired, remove it
                    localStorage.removeItem(cacheKey);
                    return null;
                } catch (e) {
                    return null;
                }
            },

            set(demoKey, code) {
                try {
                    const cacheKey = CACHE_CONFIG.DEMO_CACHE_PREFIX + demoKey;
                    localStorage.setItem(cacheKey, JSON.stringify({
                        code: code,
                        timestamp: Date.now()
                    }));
                    return true;
                } catch (e) {
                    Logger.warn('Failed to cache demo file: ' + e.message);
                    return false;
                }
            }
        };

        // ==================== JS-DOS WARMUP SYSTEM ====================
        let warmupPromise = null;
        let tcZipPromise = null; // Shared promise to prevent duplicate downloads

        // Shared function to get TC ZIP - prevents race condition between warmup and run
        async function getTCZip() {
            if (tcZipPromise) return tcZipPromise;

            tcZipPromise = (async () => {
                // Try cache first
                let blob = await CacheDB.get(CACHE_CONFIG.TC_ZIP_CACHE_KEY);
                if (blob) {
                    Logger.info('TC ZIP loaded from cache');
                    return blob;
                }

                // Download and cache
                Logger.info('Downloading TC ZIP...');
                const response = await fetch(TC_ZIP_URL);
                if (!response.ok) {
                    throw new Error(`Failed to download compiler (HTTP ${response.status})`);
                }
                blob = await response.blob();

                // Cache for next time (async, don't block)
                CacheDB.set(CACHE_CONFIG.TC_ZIP_CACHE_KEY, blob)
                    .then(cached => {
                        if (cached) Logger.success('TC ZIP cached for future use');
                    });

                return blob;
            })();

            return tcZipPromise;
        }

        // Update cache status indicator on Run button
        async function updateCacheStatus() {
            try {
                const cached = await CacheDB.get(CACHE_CONFIG.TC_ZIP_CACHE_KEY);
                if (cached && runBtn) {
                    runBtn.title = 'Run (cached - instant) [Ctrl+Enter]';
                    Logger.info('Cache status: TC ZIP is cached');
                } else if (runBtn) {
                    runBtn.title = 'Run [Ctrl+Enter]';
                }
            } catch (e) {
                // Silently ignore
            }
        }

        const canvas = document.getElementById("dos-canvas");
        const loading = document.getElementById("loading");
        const loadingText = document.getElementById("loading-text");
        const loadingProgressBar = document.getElementById("loading-progress-bar");
        const runBtn = document.getElementById("run-btn");
        const terminalWrapper = document.getElementById("terminal-wrapper");
        const keyboardBlocker = document.getElementById("keyboard-blocker");
        const editorWrapper = document.getElementById("editor-wrapper");
        const demoSelect = document.getElementById("demo-select");
        const clearBtn = document.getElementById("clear-btn");
        const editorInfo = document.getElementById("editor-info");
        const saveBtn = document.getElementById("save-btn");
        const saveIndicator = document.getElementById("save-indicator");
        const saveText = document.getElementById("save-text");

        // ==================== OUTPUT PANEL HANDLERS ====================

        // Output Panel Elements
        const outputPanel = document.getElementById("output-panel");
        const outputContent = document.getElementById("output-content");
        const closeOutputBtn = document.getElementById("close-output-btn");
        let errorUpdateInterval = null;
        let lastErrorContent = '';

        closeOutputBtn.addEventListener('click', () => {
            outputPanel.classList.remove('visible');
            terminalWrapper.classList.remove('has-panel');
            // Trigger resize to fix canvas layout
            window.dispatchEvent(new Event('resize'));
        });

        // Copy Error Button Functionality
        const copyErrorBtn = document.getElementById("copy-error-btn");
        const copyBtnText = document.getElementById("copy-btn-text");

        copyErrorBtn.addEventListener('click', async () => {
            const errorText = outputContent.textContent;

            if (!errorText || errorText.trim() === '') {
                return;
            }

            try {
                await navigator.clipboard.writeText(errorText);

                // Visual feedback
                copyErrorBtn.classList.add('copied');
                copyBtnText.textContent = 'Copied!';

                Logger.success('Errors copied to clipboard');

                // Reset after 2 seconds
                setTimeout(() => {
                    copyErrorBtn.classList.remove('copied');
                    copyBtnText.textContent = 'Copy';
                }, 2000);
            } catch (err) {
                Logger.error('Failed to copy errors', err);

                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = errorText;
                textArea.style.position = 'fixed';
                textArea.style.left = '-9999px';
                document.body.appendChild(textArea);
                textArea.select();

                try {
                    document.execCommand('copy');
                    copyErrorBtn.classList.add('copied');
                    copyBtnText.textContent = 'Copied!';

                    setTimeout(() => {
                        copyErrorBtn.classList.remove('copied');
                        copyBtnText.textContent = 'Copy';
                    }, 2000);
                } catch (fallbackErr) {
                    Logger.error('Fallback copy failed', fallbackErr);
                }

                document.body.removeChild(textArea);
            }
        });

        // Expand Button Functionality
        const expandOutputBtn = document.getElementById("expand-output-btn");
        let isOutputExpanded = false;

        expandOutputBtn.addEventListener('click', () => {
            isOutputExpanded = !isOutputExpanded;

            if (isOutputExpanded) {
                outputPanel.classList.add('expanded');
                expandOutputBtn.classList.add('expanded');
                expandOutputBtn.title = 'Collapse panel';
            } else {
                outputPanel.classList.remove('expanded');
                expandOutputBtn.classList.remove('expanded');
                expandOutputBtn.title = 'Expand panel';
            }

            // Trigger resize to fix canvas layout
            setTimeout(() => window.dispatchEvent(new Event('resize')), 310);

            Logger.info(`Output panel ${isOutputExpanded ? 'expanded' : 'collapsed'}`);
        });

        async function checkCompilationErrors() {
            try {
                // Access Emscripten FS through dosInstance.em (js-dos 6.22)
                if (!dosInstance || !dosInstance.em || !dosInstance.em.FS) {
                    return;
                }

                const FS = dosInstance.em.FS;
                const filePath = "/TURBOC3/BIN/ERR.TXT";

                // Check if file exists
                try {
                    FS.stat(filePath);
                } catch (statErr) {
                    return; // File doesn't exist yet
                }

                // Read the file content
                let content;
                try {
                    content = FS.readFile(filePath, { encoding: 'utf8' });
                } catch (readErr) {
                    const data = FS.readFile(filePath);
                    content = new TextDecoder().decode(data);
                }

                // Only update if content changed and is not empty
                if (content && content.trim() !== "" && content !== lastErrorContent) {
                    lastErrorContent = content;

                    // Check if it contains errors
                    if (content.includes("Error") || content.includes("Fatal")) {
                        outputContent.textContent = content;
                        outputContent.classList.remove('output-success');
                        outputContent.classList.add('output-error');

                        // Show panel only for errors
                        if (!outputPanel.classList.contains('visible')) {
                            outputPanel.classList.add('visible');
                            terminalWrapper.classList.add('has-panel');
                            setTimeout(() => window.dispatchEvent(new Event('resize')), 310);
                        }
                    }
                    // For successful compilation, don't show the panel
                }
            } catch (e) {
                // Silently ignore errors during polling
            }
        }

        // ==================== SAVE FUNCTIONALITY ====================

        function saveCode() {
            if (!editor) return;

            const code = editor.getValue();
            localStorage.setItem("tc_code", code);

            // Update save indicator
            saveIndicator.classList.add('saved');
            saveText.textContent = 'Saved';

            Logger.success('Code saved to browser storage');

            // Reset indicator after 2 seconds
            setTimeout(() => {
                saveIndicator.classList.remove('saved');
                saveText.textContent = 'Not Saved';
            }, 2000);
        }

        function updateSaveIndicator() {
            const savedCode = localStorage.getItem("tc_code");
            const currentCode = editor ? editor.getValue() : '';

            if (savedCode === currentCode && savedCode !== '') {
                saveIndicator.classList.add('saved');
                saveText.textContent = 'Saved';
            } else {
                saveIndicator.classList.remove('saved');
                saveText.textContent = 'Not Saved';
            }
        }

        // ==================== SCRIPT LOADING WITH FALLBACK ====================

        function loadScript(url, fallbackUrl, timeout = 5000) {
            return new Promise((resolve, reject) => {
                const tryLoad = (src, isFallback = false) => {
                    return new Promise((res, rej) => {
                        const script = document.createElement('script');
                        script.src = src;

                        const timer = setTimeout(() => {
                            script.onerror = null;
                            script.onload = null;
                            rej(new Error('Timeout'));
                        }, timeout);

                        script.onload = () => {
                            clearTimeout(timer);
                            if (isFallback) {
                                Logger.info(`Using fallback: ${src}`);
                            }
                            res(true);
                        };

                        script.onerror = () => {
                            clearTimeout(timer);
                            rej(new Error(`Failed to load: ${src}`));
                        };

                        document.head.appendChild(script);
                    });
                };

                tryLoad(url)
                    .then(resolve)
                    .catch(() => {
                        Logger.warn(`Primary source failed, trying fallback`);
                        tryLoad(fallbackUrl, true)
                            .then(resolve)
                            .catch(reject);
                    });
            });
        }

        async function loadAllScripts() {
            try {
                Logger.info('Loading dependencies...');
                updateLoadingProgress(10);

                // Load JS-DOS
                await loadScript(
                    'https://js-dos.com/6.22/current/js-dos.js',
                    './libs/js-dos.js'
                );
                scriptsLoaded.jsdos = true;
                updateLoadingProgress(30);

                // Load Ace Editor
                await loadScript(
                    'https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js',
                    './libs/ace.js'
                );
                scriptsLoaded.ace = true;
                updateLoadingProgress(50);

                await waitForAce();

                // Load Ace C++ Mode
                await loadScript(
                    'https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/mode-c_cpp.js',
                    './libs/mode-c_cpp.js'
                );
                scriptsLoaded.aceMode = true;
                updateLoadingProgress(70);

                // Load Ace Monokai Theme
                await loadScript(
                    'https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/theme-monokai.js',
                    './libs/theme-monokai.js'
                );

                // Load Ace Textmate Theme for light mode
                await loadScript(
                    'https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/theme-textmate.js',
                    './libs/theme-textmate.js'
                );

                scriptsLoaded.aceTheme = true;
                updateLoadingProgress(100);

                Logger.success('All dependencies loaded');
                return true;
            } catch (error) {
                Logger.error('Failed to load dependencies', error);
                alert('Failed to load required libraries. Please check your connection and try again.');
                return false;
            }
        }

        function updateLoadingProgress(percent) {
            if (loadingProgressBar) {
                loadingProgressBar.style.width = `${percent}%`;
            }
        }

        function waitForAce() {
            return new Promise((resolve) => {
                const checkAce = setInterval(() => {
                    if (typeof ace !== 'undefined') {
                        clearInterval(checkAce);
                        resolve();
                    }
                }, 50);
            });
        }

        // ==================== DEMO FILE MANAGEMENT - FIXED ====================

        demoSelect.addEventListener('change', async (e) => {
            const selectedDemo = e.target.value;

            // Check if clicking the same demo that's already loaded
            if (selectedDemo === lastLoadedDemo) {
                Logger.info(`Reloading ${selectedDemo} demo (force refresh)`);
                await loadDemoFile(selectedDemo, true); // Force reload
            } else {
                currentDemo = selectedDemo;
                await loadDemoFile(selectedDemo, false);
            }
        });

        async function loadDemoFile(demoKey, forceReload = false) {
            if (!editor) return;

            const demoUrl = DEMO_FILES[demoKey];
            if (!demoUrl) {
                Logger.error(`Demo file not found: ${demoKey}`);
                return;
            }

            try {
                // Check cache first (unless force reload)
                if (!forceReload) {
                    const cachedCode = DemoCache.get(demoKey);
                    if (cachedCode) {
                        Logger.info(`Loading ${demoKey} demo from cache`);
                        editor.setValue('', -1);
                        await new Promise(resolve => setTimeout(resolve, 50));
                        editor.setValue(cachedCode, -1);
                        editor.clearSelection();
                        editor.moveCursorTo(0, 0);

                        lastLoadedDemo = demoKey;
                        currentDemo = demoKey;
                        localStorage.removeItem("tc_code");

                        updateEditorInfo();
                        updateSaveIndicator();

                        Logger.success(`Loaded ${demoKey} demo from cache`);
                        return;
                    }
                }

                Logger.info(`Loading ${demoKey} demo from Blob storage...${forceReload ? ' (force reload)' : ''}`);

                // Add cache buster for force reload
                const cacheBuster = forceReload ? `?t=${Date.now()}` : '';
                const response = await fetch(demoUrl + cacheBuster);

                if (response.ok) {
                    const code = await response.text();

                    // Cache the demo file
                    DemoCache.set(demoKey, code);

                    editor.setValue('', -1);
                    await new Promise(resolve => setTimeout(resolve, 50));
                    editor.setValue(code, -1);
                    editor.clearSelection();
                    editor.moveCursorTo(0, 0);

                    // Update last loaded demo
                    lastLoadedDemo = demoKey;
                    currentDemo = demoKey;

                    // Clear saved code when loading a demo
                    localStorage.removeItem("tc_code");

                    updateEditorInfo();
                    updateSaveIndicator();

                    Logger.success(`Loaded ${demoKey} demo from Blob storage`);
                } else {
                    Logger.error(`Failed to load demo: ${response.status}`);
                    alert('Failed to load demo file. Please try again.');
                }
            } catch (e) {
                Logger.error('Error loading demo file', e);
                alert('Error loading demo file. Please check your connection.');
            }
        }

        // ==================== EDITOR INITIALIZATION ====================

        async function initializeEditor() {
            if (!scriptsLoaded.ace || typeof ace === 'undefined') {
                setTimeout(initializeEditor, 100);
                return;
            }

            editor = ace.edit("editor");

            // Set theme based on current theme setting
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const aceTheme = currentTheme === 'dark' ? 'ace/theme/monokai' : 'ace/theme/textmate';
            editor.setTheme(aceTheme);

            editor.session.setMode("ace/mode/c_cpp");

            editor.setShowPrintMargin(false);
            editor.setOptions({
                enableBasicAutocompletion: true,
                enableLiveAutocompletion: true,
                fontSize: "16px",
                fontFamily: "'JetBrains Mono', 'Fira Code', monospace",
                highlightActiveLine: true,
                showGutter: true,
                tabSize: 4,
                useSoftTabs: true,
                wrap: true
            });

            await loadDefaultCode();

            editor.on('change', () => {
                updateEditorInfo();
                updateSaveIndicator();
                checkForScanf();
            });

            setTimeout(() => {
                editor.focus();
                editorWrapper.classList.add('active');
            }, 100);

            Logger.success('Editor ready');
        }

        function updateEditorInfo() {
            if (!editor || !editorInfo) return;

            const code = editor.getValue();
            const lines = code.split('\n').length;
            const chars = code.length;

            editorInfo.textContent = `Lines: ${lines} | Chars: ${chars}`;
        }

        // ==================== SCANF WARNING SYSTEM ====================
        const scanfWarning = document.getElementById('scanf-warning');
        const scanfWarningClose = document.getElementById('scanf-warning-close');
        let scanfWarningDismissed = false; // Track if user manually dismissed the warning

        // Pattern to detect scanf or cin in the code
        const SCANF_PATTERN = /\b(scanf|cin)\b/;

        function checkForScanf() {
            if (!editor || !scanfWarning) return;

            const code = editor.getValue();
            const hasScanf = SCANF_PATTERN.test(code);

            if (hasScanf && !scanfWarningDismissed) {
                scanfWarning.classList.add('visible');
            } else {
                scanfWarning.classList.remove('visible');
                // Reset dismissal state when scanf is removed
                if (!hasScanf) {
                    scanfWarningDismissed = false;
                }
            }
        }

        // Close button handler - allows user to dismiss the warning
        scanfWarningClose.addEventListener('click', () => {
            scanfWarning.classList.remove('visible');
            scanfWarningDismissed = true;
            Logger.info('Scanf warning dismissed by user');
        });

        async function loadDefaultCode() {
            const savedCode = localStorage.getItem("tc_code");
            if (savedCode) {
                editor.setValue(savedCode, -1);
                updateEditorInfo();
                updateSaveIndicator();
                checkForScanf(); // Check for scanf on initial load
                Logger.info('Restored saved code');
                return;
            }

            // Load default demo (graphics-demo)
            await loadDemoFile('graphics-demo', false);
        }

        // Clear button functionality
        clearBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to clear the editor?')) {
                editor.setValue('', -1);
                localStorage.removeItem("tc_code");
                lastLoadedDemo = ''; // Reset last loaded demo
                updateEditorInfo();
                updateSaveIndicator();
                Logger.info('Editor cleared');
            }
        });

        // ==================== FULLSCREEN FUNCTIONALITY - FIXED ====================

        let isEditorFullscreen = false;
        let isTerminalFullscreen = false;

        document.getElementById('fullscreen-editor-btn').addEventListener('click', () => {
            isEditorFullscreen = !isEditorFullscreen;

            if (isEditorFullscreen) {
                editorWrapper.classList.add('fullscreen');
                terminalWrapper.classList.add('hidden');
            } else {
                editorWrapper.classList.remove('fullscreen');
                terminalWrapper.classList.remove('hidden');
            }

            // Force editor resize after fullscreen toggle
            setTimeout(() => {
                if (editor) {
                    editor.resize();
                    editor.renderer.updateFull();
                }
            }, 100);
        });

        document.getElementById('fullscreen-terminal-btn').addEventListener('click', () => {
            isTerminalFullscreen = !isTerminalFullscreen;

            if (isTerminalFullscreen) {
                terminalWrapper.classList.add('fullscreen');
                editorWrapper.classList.add('hidden');
            } else {
                terminalWrapper.classList.remove('fullscreen');
                editorWrapper.classList.remove('hidden');
            }

            // Force canvas resize after fullscreen toggle
            setTimeout(() => {
                if (dosInstance) {
                    // Trigger canvas resize
                    window.dispatchEvent(new Event('resize'));
                }
            }, 100);
        });

        // ==================== KEYBOARD INPUT ISOLATION ====================

        let keyboardEventBlocker = null;

        function setupKeyboardBlocker() {
            keyboardEventBlocker = function (e) {
                if (!terminalFocused) {
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    return false;
                }
            };

            window.addEventListener('keydown', keyboardEventBlocker, true);
            window.addEventListener('keyup', keyboardEventBlocker, true);
            window.addEventListener('keypress', keyboardEventBlocker, true);
        }

        // ==================== FOCUS MANAGEMENT ====================

        function focusTerminal() {
            if (!dosInstance) return;

            terminalFocused = true;
            canvas.focus();
            canvas.tabIndex = 1;
            terminalWrapper.classList.add('terminal-active');
            editorWrapper.classList.remove('active');
            keyboardBlocker.classList.remove('active');
        }

        function focusEditor() {
            if (!editor) return;

            terminalFocused = false;
            canvas.tabIndex = -1;
            canvas.blur();
            editor.focus();
            terminalWrapper.classList.remove('terminal-active');
            editorWrapper.classList.add('active');
            keyboardBlocker.classList.add('active');
        }

        keyboardBlocker.addEventListener('click', () => {
            focusTerminal();
        });

        terminalWrapper.addEventListener('click', (e) => {
            if (e.target === terminalWrapper || e.target === canvas) {
                if (dosInstance && !terminalFocused) {
                    focusTerminal();
                }
            }
        });

        editorWrapper.addEventListener('click', () => {
            focusEditor();
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                focusEditor();
                return false;
            }
        }, true);

        // ==================== RUN PROGRAM ====================

        async function runProgram() {
            if (!editor) {
                alert('Editor is still loading. Please wait...');
                return;
            }

            const code = editor.getValue();

            if (!code.trim()) {
                alert('Please write some code first!');
                return;
            }

            Logger.info('Starting compilation...');
            loading.classList.add('active');
            loadingText.textContent = 'Initializing DOS environment...';
            updateLoadingProgress(0);
            runBtn.disabled = true;
            runBtn.classList.add('loading');

            if (dosInstance) {
                try {
                    dosInstance.exit();
                } catch (e) {
                    Logger.warn('Error closing previous DOS instance');
                }
                dosInstance = null;
            }

            // Clear existing error interval
            if (errorUpdateInterval) {
                clearInterval(errorUpdateInterval);
                errorUpdateInterval = null;
            }

            // Hide panel initially
            outputPanel.classList.remove('visible');
            terminalWrapper.classList.remove('has-panel');
            lastErrorContent = '';
            outputContent.textContent = '';

            try {
                // Wait for Dos to be available
                if (!scriptsLoaded.jsdos || typeof Dos === 'undefined') {
                    loadingText.textContent = 'Waiting for JS-DOS...';
                    updateLoadingProgress(20);
                    await new Promise((resolve) => {
                        const checkDos = setInterval(() => {
                            if (typeof Dos !== 'undefined') {
                                clearInterval(checkDos);
                                resolve();
                            }
                        }, 100);
                    });
                }

                updateLoadingProgress(40);

                // Determine wdosbox URL with proper fallback
                let wdosboxUrl = './libs/wdosbox.js';
                let usingOnline = false;

                if (navigator.onLine) {
                    try {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 3000);

                        const response = await fetch("https://js-dos.com/6.22/current/wdosbox.js", {
                            method: 'HEAD',
                            cache: 'no-cache',
                            signal: controller.signal
                        });

                        clearTimeout(timeoutId);

                        if (response.ok) {
                            wdosboxUrl = "https://js-dos.com/6.22/current/wdosbox.js";
                            usingOnline = true;
                        }
                    } catch (e) {
                        Logger.info('Using local WDOSBOX due to network timeout');
                    }
                }

                Logger.info(`Using ${usingOnline ? 'CDN' : 'local'} WDOSBOX`);
                updateLoadingProgress(60);

                Dos(canvas, {
                    wdosboxUrl: wdosboxUrl,
                    cycles: "max",
                    autolock: false,
                }).ready(async (fs, main) => {

                    loadingText.textContent = 'Loading Turbo C++...';
                    updateLoadingProgress(70);

                    try {
                        // Use shared getTCZip to prevent race condition with warmup
                        loadingText.textContent = 'Loading compiler...';
                        const tcBlob = await getTCZip();

                        // Create a temporary URL for the blob
                        const blobUrl = URL.createObjectURL(tcBlob);

                        Logger.info('Extracting compiler files...');
                        loadingText.textContent = 'Extracting compiler files...';

                        // Now extract from the blob URL - js-dos can handle blob: URLs
                        await fs.extract(blobUrl);

                        // Clean up the blob URL
                        URL.revokeObjectURL(blobUrl);

                        Logger.success('Turbo C compiler loaded');
                    } catch (e) {
                        Logger.error('Compiler extraction failed', e);
                        throw new Error('Failed to load compiler: ' + e.message);
                    }

                    loadingText.textContent = 'Writing source code...';
                    updateLoadingProgress(80);
                    fs.createFile("TURBOC3/BIN/USER.CPP", code);

                    const batchScript = `@ECHO OFF
CD TURBOC3\\BIN
IF EXIST USER.EXE DEL USER.EXE
IF EXIST ERR.TXT DEL ERR.TXT
TCC -I..\\INCLUDE -L..\\LIB -n. USER.CPP ..\\LIB\\GRAPHICS.LIB > ERR.TXT
IF EXIST USER.EXE GOTO SUCCESS
CLS
ECHO ========================================
ECHO COMPILATION ERRORS:
ECHO ========================================
TYPE ERR.TXT
ECHO.
PAUSE
EXIT
:SUCCESS
CLS
USER.EXE
PAUSE
`;

                    fs.createFile("AUTOEXEC.BAT", batchScript);

                    loadingText.textContent = 'Starting program...';
                    updateLoadingProgress(90);

                    dosInstance = await main(["-conf", "dosbox.conf", "AUTOEXEC.BAT"]);

                    setupKeyboardBlocker();

                    updateLoadingProgress(100);
                    loading.classList.remove('active');
                    runBtn.disabled = false;
                    runBtn.classList.remove('loading');

                    Logger.success('Program started successfully');

                    setTimeout(() => {
                        focusTerminal();
                    }, 500);

                    // Start checking for compilation errors
                    errorUpdateInterval = setInterval(() => checkCompilationErrors(), 1000);
                });

            } catch (error) {
                Logger.error('Failed to start DOS environment', error);
                alert('Failed to start DOS environment. Error: ' + error.message);
                loading.classList.remove('active');
                runBtn.disabled = false;
                runBtn.classList.remove('loading');
                updateLoadingProgress(0);
            }
        }

        // ==================== KEYBOARD SHORTCUTS ====================

        window.addEventListener('keydown', (e) => {
            // Ctrl/Cmd + Enter to run
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter' && !terminalFocused) {
                e.preventDefault();
                runProgram();
            }

            // Ctrl/Cmd + S to save
            if ((e.ctrlKey || e.metaKey) && e.key === 's' && !terminalFocused) {
                e.preventDefault();
                saveCode();
            }
        });

        // ==================== RESPONSIVE HANDLING ====================

        function handleResize() {
            if (editor) {
                editor.resize();
                editor.renderer.updateFull();
            }
        }

        window.addEventListener('resize', handleResize);
        window.addEventListener('orientationchange', () => {
            setTimeout(handleResize, 300);
        });

        // ==================== JS-DOS BACKGROUND WARMUP ====================

        async function warmupJSDOS() {
            if (warmupPromise) return warmupPromise;

            warmupPromise = new Promise(async (resolve) => {
                try {
                    // Wait for JS-DOS to be available
                    if (typeof Dos === 'undefined') {
                        let attempts = 0;
                        while (typeof Dos === 'undefined' && attempts < 50) {
                            await new Promise(r => setTimeout(r, 100));
                            attempts++;
                        }
                        if (typeof Dos === 'undefined') {
                            Logger.warn('JS-DOS not available for warmup');
                            resolve(false);
                            return;
                        }
                    }

                    Logger.info('Starting JS-DOS background warmup...');

                    // Pre-fetch and cache TC ZIP using shared function
                    try {
                        await getTCZip();
                        Logger.success('TC ZIP ready for instant run');
                    } catch (e) {
                        Logger.warn('Failed to pre-cache TC ZIP: ' + e.message);
                    }

                    // Pre-cache all demo files in background
                    prefetchDemoFiles();

                    Logger.success('JS-DOS warmup complete - Run will be instant!');
                    resolve(true);
                } catch (e) {
                    Logger.warn('Warmup failed: ' + e.message);
                    resolve(false);
                }
            });

            return warmupPromise;
        }

        async function prefetchDemoFiles() {
            // Pre-fetch all demo files in background
            for (const [key, url] of Object.entries(DEMO_FILES)) {
                if (!DemoCache.get(key)) {
                    try {
                        const response = await fetch(url);
                        if (response.ok) {
                            const code = await response.text();
                            DemoCache.set(key, code);
                            Logger.info(`Pre-cached demo: ${key}`);
                        }
                    } catch (e) {
                        // Silently fail for background prefetch
                    }
                }
            }
        }

        // ==================== INITIALIZATION ====================

        (async function init() {
            Logger.info('Initializing compiler...');
            updateSaveIndicator();

            const loaded = await loadAllScripts();
            if (loaded) {
                await initializeEditor();

                // Start background warmup after editor is ready
                // This runs silently in background, making Run feel instant
                setTimeout(() => {
                    warmupJSDOS();
                    updateCacheStatus();
                }, 500);

                Logger.success('Compiler ready');
            }
        })();

    </script>

</body>

</html>