<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Graphics.h Online Compiler | Turbo C++ DOS Emulation</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Free graphics.h online compiler for Turbo C++ with DOS emulation. Instantly run and test graphics.h code in your browser.">
    <link rel="canonical" href="https://graphics-h-compiler.vercel.app/compiler.html">

    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="Graphics.h Online Compiler | Turbo C++ DOS Emulation">
    <meta property="og:description" content="Run graphics.h code online with Turbo C++ and DOS emulation. No installation, free and browser-based.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://graphics-h-compiler.vercel.app/compiler.html">

    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Graphics.h Online Compiler | Turbo C++ DOS Emulation">
    <meta name="twitter:description" content="Free Turbo C++ graphics.h online compiler with DOS emulation. Instantly run graphics.h code in your browser.">
    <meta name="twitter:url" content="https://graphics-h-compiler.vercel.app/compiler.html">

    <!-- Structured Data: SoftwareApplication Schema -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
      "name": "Graphics.h Online Compiler",
      "url": "https://graphics-h-compiler.vercel.app/compiler.html",
      "applicationCategory": "DeveloperApplication",
      "operatingSystem": "Web",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      },
      "description": "Graphics.h Online Compiler is a free Turbo C++ graphics.h compiler with DOS emulation. Instantly run graphics.h code in your browser. Supports Turbo C graphics, DOSBox emulation, and is designed for graphics.h learners.",
      "keywords": "graphics.h online compiler, Turbo C graphics, DOS emulation, Turbo C++ online, graphics.h browser, Turbo C wrapper",
      "softwareVersion": "1.0",
      "author": {
        "@type": "Person",
        "name": "AlbatrossC"
      },
      "publisher": {
        "@type": "Organization",
        "name": "Graphics.h Online Compiler",
        "url": "https://github.com/AlbatrossC/graphics-h-compiler"
      },
      "inLanguage": "en"
    }
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* VS Code Dark+ Colors */
            --vscode-bg: #1e1e1e;
            --vscode-sidebar: #252526;
            --vscode-editor: #1e1e1e;
            --vscode-line-bg: #282828;
            --vscode-border: #3e3e42;
            
            /* Flat Colors - No Gradients */
            --primary: #007acc;
            --primary-hover: #1a8ccc;
            --success: #4ec9b0;
            --success-hover: #5dd4bb;
            --danger: #f48771;
            --warning: #dcdcaa;
            --home-green: #16a34a;
            --home-green-hover: #22c55e;
            --demo-purple: #5572f2;
            --demo-purple-hover: rgb(143, 36, 243);
            
            --text-primary: #d4d4d4;
            --text-secondary: #858585;
            --text-muted: #6a6a6a;
            
            --border-color: #3e3e42;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--vscode-bg);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
        }

        /* Header */
        header {
            background: var(--vscode-sidebar);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.625rem 1.25rem;
            gap: 1rem;
        }

        .header-left, .header-right {
            display: flex;
            align-items: center;
            gap: 0.625rem;
        }

        .header-center {
            flex: 1;
            text-align: center;
        }

        .logo {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            letter-spacing: -0.02em;
        }

        .logo-highlight {
            color: var(--primary);
        }

        /* Consistent Button Sizes - Slightly Smaller with Smooth Curves */
        .btn, .icon-btn, .demo-dropdown, .connection-status, .header-status, .save-indicator {
            height: 34px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
            border: 1px solid var(--border-color);
            cursor: pointer;
            background: var(--vscode-sidebar);
            color: var(--text-primary);
        }

        .btn {
            padding: 0 14px;
            gap: 7px;
        }

        .btn svg {
            width: 15px;
            height: 15px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-hover);
            border-color: var(--primary-hover);
            transform: translateY(-1px);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--vscode-sidebar);
            border-color: var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--vscode-line-bg);
            border-color: var(--primary);
        }

        /* Home Button - Green */
        .btn-home {
            background: var(--home-green);
            color: white;
            border-color: var(--home-green);
        }

        .btn-home:hover {
            background: var(--home-green-hover);
            border-color: var(--home-green-hover);
            transform: translateY(-1px);
        }

        .btn-success {
            background: var(--success);
            color: var(--vscode-bg);
            border-color: var(--success);
        }

        .btn-success:hover {
            background: var(--success-hover);
            border-color: var(--success-hover);
            transform: translateY(-1px);
        }

        .icon-btn {
            width: 34px;
            padding: 0;
        }

        .icon-btn svg {
            width: 17px;
            height: 17px;
        }

        .icon-btn:hover {
            background: var(--vscode-line-bg);
            border-color: var(--primary);
            color: var(--primary);
            transform: translateY(-1px);
        }

        /* Demo Selector - Purple Color */
        .demo-selector {
            display: flex;
            align-items: center;
            gap: 0.625rem;
        }

        .demo-selector label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .demo-dropdown {
            padding: 0 12px;
            min-width: 190px;
            cursor: pointer;
            background: var(--demo-purple);
            color: white;
            border-color: var(--demo-purple);
            font-weight: 600;
        }

        .demo-dropdown:hover {
            background: var(--demo-purple-hover);
            border-color: var(--demo-purple-hover);
            transform: translateY(-1px);
        }

        .demo-dropdown:focus {
            outline: none;
            border-color: var(--demo-purple-hover);
            box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.2);
        }

        /* Status Indicators */
        .connection-status, .header-status, .save-indicator {
            padding: 0 11px;
            gap: 7px;
            font-size: 0.8125rem;
            cursor: default;
        }

        .connection-status.online {
            background: rgba(78, 201, 176, 0.15);
            border-color: rgba(78, 201, 176, 0.3);
            color: var(--success);
        }

        .connection-status.offline {
            background: rgba(244, 135, 113, 0.15);
            border-color: rgba(244, 135, 113, 0.3);
            color: var(--danger);
        }

        .connection-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: currentColor;
        }

        .connection-status.online .connection-dot {
            animation: pulse 2s infinite;
        }

        .header-status.active {
            background: rgba(0, 122, 204, 0.15);
            border-color: rgba(0, 122, 204, 0.3);
            color: var(--primary);
        }

        .header-status svg {
            width: 13px;
            height: 13px;
        }

        .save-indicator.saved {
            background: rgba(78, 201, 176, 0.15);
            border-color: rgba(78, 201, 176, 0.3);
            color: var(--success);
        }

        .save-indicator svg {
            width: 13px;
            height: 13px;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Workspace */
        #workspace {
            display: flex;
            height: calc(100vh - 56px);
            gap: 0;
            overflow: hidden;
        }

        #editor-wrapper, #terminal-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--vscode-editor);
            border: 1px solid var(--border-color);
            transition: none;
            position: relative;
            overflow: hidden;
        }

        #editor-wrapper {
            border-right: 1px solid var(--border-color);
        }

        #editor-wrapper.active {
            border-color: var(--primary);
        }

        #terminal-wrapper.terminal-active {
            border-color: var(--success);
        }

        /* Fullscreen Fix */
        .fullscreen {
            position: fixed !important;
            top: 0;
            left: 0;
            width: 100vw !important;
            height: 100vh !important;
            z-index: 1000;
            flex: none !important;
            border: none !important;
        }

        .hidden {
            display: none !important;
        }

        /* Panel Header */
        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
            background: var(--vscode-sidebar);
            border-bottom: 1px solid var(--border-color);
            min-height: 42px;
            flex-shrink: 0;
        }

        .panel-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            font-size: 0.8125rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .panel-icon {
            width: 16px;
            height: 16px;
            color: var(--primary);
        }

        .panel-actions {
            display: flex;
            gap: 8px;
        }

        /* Editor */
        #editor {
            flex: 1;
            width: 100%;
            font-size: 14px;
            background: var(--vscode-editor) !important;
            overflow: hidden;
        }

        /* Override Ace Editor default background */
        .ace_editor {
            background: var(--vscode-editor) !important;
        }

        .ace-monokai .ace_gutter {
            background: var(--vscode-sidebar) !important;
            color: var(--text-secondary) !important;
        }

        .ace-monokai .ace_gutter-active-line {
            background: var(--vscode-line-bg) !important;
        }

        .editor-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 14px;
            background: var(--vscode-sidebar);
            border-top: 1px solid var(--border-color);
            font-size: 0.75rem;
            color: var(--text-muted);
            min-height: 32px;
            flex-shrink: 0;
        }

        .editor-mode {
            padding: 3px 10px;
            background: var(--primary);
            color: white;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.75rem;
        }

        /* Terminal/Canvas - Fixed */
        #dos-canvas {
            width: 100%;
            height: 100%;
            background: #000;
            cursor: pointer;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            display: block;
        }

        /* Keyboard Blocker */
        .keyboard-blocker {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .keyboard-blocker.active {
            opacity: 1;
            pointer-events: all;
        }

        .blocker-message {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 24px;
            background: var(--vscode-sidebar);
            border: 2px solid var(--primary);
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.9375rem;
            color: var(--text-primary);
            box-shadow: var(--shadow);
            animation: bounce 2s infinite;
        }

        .blocker-message svg {
            width: 22px;
            height: 22px;
            color: var(--primary);
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        /* Loading Overlay */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--vscode-bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
            z-index: 20;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .loading-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .spinner {
            width: 44px;
            height: 44px;
            border: 3px solid rgba(0, 122, 204, 0.3);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .loading-progress {
            width: 320px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
            position: relative;
        }

        .loading-progress-bar {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.3s ease;
        }

        /* Responsive */
        @media (max-width: 768px) {
            #workspace {
                flex-direction: column;
            }

            .header-content {
                flex-wrap: wrap;
                gap: 0.625rem;
                padding: 0.625rem 1rem;
            }

            .btn-text {
                display: none;
            }

            .demo-dropdown {
                min-width: 160px;
                font-size: 0.875rem;
            }

            .logo {
                font-size: 1rem;
            }
        }
    </style>

    <script src="static/analytics.js" defer></script>
</head>

<body>

<header>
    <div class="header-content">
        <div class="header-left">
            <button id="back-btn" class="btn btn-home" onclick="window.location.href='index.html'">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
                </svg>
                <span class="btn-text">Home</span>
            </button>
            
            <div class="demo-selector">
                <label for="demo-select">Demo:</label>
                <select id="demo-select" class="demo-dropdown">
                    <option value="circle-pattern">Circle Pattern</option>
                    <option value="bouncing-ball">Bouncing Ball</option>
                    <option value="shooter-game">Shooter Game</option>
                </select>
            </div>
        </div>
        
        <div class="header-center">
            <div class="logo">
                Online <span class="logo-highlight">graphics.h</span> C++ Compiler
            </div>
        </div>
        
        <div class="header-right">
            <div class="connection-status" id="connection-status">
                <span class="connection-dot"></span>
                <span class="connection-text">Online</span>
            </div>
            
            <div class="save-indicator" id="save-indicator">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/>
                </svg>
                <span id="save-text">Not Saved</span>
            </div>

            <button id="save-btn" class="btn btn-success" onclick="saveCode()">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/>
                </svg>
                <span class="btn-text">Save</span>
            </button>
            
            <div class="header-status" id="header-status">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
                <span class="status-text">Ready</span>
            </div>
            
            <button id="run-btn" class="btn btn-primary" onclick="runProgram()">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M8 5v14l11-7z"/>
                </svg>
                <span class="btn-text">Compile & Run</span>
            </button>
        </div>
    </div>
</header>

<div id="workspace">
    <div id="editor-wrapper">
        <div class="panel-header">
            <div class="panel-title">
                <svg viewBox="0 0 24 24" fill="currentColor" class="panel-icon">
                    <path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"/>
                </svg>
                Source Code Editor
            </div>
            <div class="panel-actions">
                <button id="clear-btn" class="icon-btn" title="Clear Editor">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                    </svg>
                </button>
                <button id="fullscreen-editor-btn" class="icon-btn" title="Toggle Fullscreen">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>
                    </svg>
                </button>
            </div>
        </div>
        <div id="editor"></div>
        <div class="editor-footer">
            <span class="editor-info" id="editor-info">Lines: 0 | Chars: 0</span>
            <span class="editor-mode">C++</span>
        </div>
    </div>

    <div id="terminal-wrapper">
        <div class="panel-header">
            <div class="panel-title">
                <svg viewBox="0 0 24 24" fill="currentColor" class="panel-icon">
                    <path d="M20 4H4c-1.11 0-2 .89-2 2v12c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4V8h16v10z"/>
                </svg>
                DOS Output
            </div>
            <div class="panel-actions">
                <button id="fullscreen-terminal-btn" class="icon-btn" title="Toggle Fullscreen">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>
                    </svg>
                </button>
            </div>
        </div>
        
        <div class="keyboard-blocker" id="keyboard-blocker">
            <div class="blocker-message">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
                Click to interact with terminal
            </div>
        </div>
        
        <div class="loading-overlay" id="loading">
            <div class="spinner"></div>
            <div class="loading-text" id="loading-text">Initializing...</div>
            <div class="loading-progress">
                <div class="loading-progress-bar" id="loading-progress-bar"></div>
            </div>
        </div>
        
        <canvas id="dos-canvas" tabindex="-1"></canvas>
    </div>
</div>

<script>
    // ==================== LOGGER ====================
    const Logger = {
        prefix: '[Graphics.h Compiler]',
        
        info(msg) {
            console.log(`${this.prefix} ${msg}`);
        },
        
        success(msg) {
            console.log(`${this.prefix} ✓ ${msg}`);
        },
        
        error(msg, err) {
            console.error(`${this.prefix} ✗ ${msg}`, err || '');
        },
        
        warn(msg) {
            console.warn(`${this.prefix} ⚠ ${msg}`);
        }
    };

    // ==================== CONNECTION STATUS ====================
    function updateConnectionStatus() {
        const statusEl = document.getElementById('connection-status');
        const isOnline = navigator.onLine;
        
        statusEl.className = `connection-status ${isOnline ? 'online' : 'offline'}`;
        statusEl.querySelector('.connection-text').textContent = isOnline ? 'Online' : 'Offline';
    }

    window.addEventListener('online', () => {
        updateConnectionStatus();
        Logger.info('Connection restored');
    });

    window.addEventListener('offline', () => {
        updateConnectionStatus();
        Logger.warn('Connection lost - using local resources');
    });

    // ==================== GLOBAL STATE ====================
    let dosInstance = null;
    let terminalFocused = false;
    let editor = null;
    let currentDemo = 'circle-pattern';
    let lastLoadedDemo = ''; // Track last loaded demo
    let scriptsLoaded = {
        jsdos: false,
        ace: false,
        aceMode: false,
        aceTheme: false
    };

    // Demo files configuration - FETCHING FROM BLOB STORAGE
    const DEMO_FILES = {
        'circle-pattern': 'https://ltjlklxc9homgiye.public.blob.vercel-storage.com/demo/circle-pattern.cpp',
        'bouncing-ball': 'https://ltjlklxc9homgiye.public.blob.vercel-storage.com/demo/bouncing-ball.cpp',
        'shooter-game': 'https://ltjlklxc9homgiye.public.blob.vercel-storage.com/demo/shooter-game.cpp'
    };

    // TC.ZIP URL - FETCHING FROM BLOB STORAGE
    const TC_ZIP_URL = 'https://ltjlklxc9homgiye.public.blob.vercel-storage.com/zips/tc-v1.zip';

    const canvas = document.getElementById("dos-canvas");
    const headerStatus = document.getElementById("header-status");
    const loading = document.getElementById("loading");
    const loadingText = document.getElementById("loading-text");
    const loadingProgressBar = document.getElementById("loading-progress-bar");
    const runBtn = document.getElementById("run-btn");
    const terminalWrapper = document.getElementById("terminal-wrapper");
    const keyboardBlocker = document.getElementById("keyboard-blocker");
    const editorWrapper = document.getElementById("editor-wrapper");
    const demoSelect = document.getElementById("demo-select");
    const clearBtn = document.getElementById("clear-btn");
    const editorInfo = document.getElementById("editor-info");
    const saveBtn = document.getElementById("save-btn");
    const saveIndicator = document.getElementById("save-indicator");
    const saveText = document.getElementById("save-text");

    // ==================== SAVE FUNCTIONALITY ====================
    
    function saveCode() {
        if (!editor) return;
        
        const code = editor.getValue();
        localStorage.setItem("tc_code", code);
        
        // Update save indicator
        saveIndicator.classList.add('saved');
        saveText.textContent = 'Saved';
        
        Logger.success('Code saved to browser storage');
        
        // Reset indicator after 2 seconds
        setTimeout(() => {
            saveIndicator.classList.remove('saved');
            saveText.textContent = 'Not Saved';
        }, 2000);
    }

    function updateSaveIndicator() {
        const savedCode = localStorage.getItem("tc_code");
        const currentCode = editor ? editor.getValue() : '';
        
        if (savedCode === currentCode && savedCode !== '') {
            saveIndicator.classList.add('saved');
            saveText.textContent = 'Saved';
        } else {
            saveIndicator.classList.remove('saved');
            saveText.textContent = 'Not Saved';
        }
    }

    // ==================== SCRIPT LOADING WITH FALLBACK ====================
    
    function loadScript(url, fallbackUrl, timeout = 5000) {
        return new Promise((resolve, reject) => {
            const tryLoad = (src, isFallback = false) => {
                return new Promise((res, rej) => {
                    const script = document.createElement('script');
                    script.src = src;
                    
                    const timer = setTimeout(() => {
                        script.onerror = null;
                        script.onload = null;
                        rej(new Error('Timeout'));
                    }, timeout);
                    
                    script.onload = () => {
                        clearTimeout(timer);
                        if (isFallback) {
                            Logger.info(`Using fallback: ${src}`);
                        }
                        res(true);
                    };
                    
                    script.onerror = () => {
                        clearTimeout(timer);
                        rej(new Error(`Failed to load: ${src}`));
                    };
                    
                    document.head.appendChild(script);
                });
            };

            tryLoad(url)
                .then(resolve)
                .catch(() => {
                    Logger.warn(`Primary source failed, trying fallback`);
                    tryLoad(fallbackUrl, true)
                        .then(resolve)
                        .catch(reject);
                });
        });
    }

    async function loadAllScripts() {
        try {
            Logger.info('Loading dependencies...');
            updateLoadingProgress(10);
            
            // Load JS-DOS
            await loadScript(
                'https://js-dos.com/6.22/current/js-dos.js',
                './libs/js-dos.js'
            );
            scriptsLoaded.jsdos = true;
            updateLoadingProgress(30);

            // Load Ace Editor
            await loadScript(
                'https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js',
                './libs/ace.js'
            );
            scriptsLoaded.ace = true;
            updateLoadingProgress(50);

            await waitForAce();

            // Load Ace C++ Mode
            await loadScript(
                'https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/mode-c_cpp.js',
                './libs/mode-c_cpp.js'
            );
            scriptsLoaded.aceMode = true;
            updateLoadingProgress(70);

            // Load Ace Monokai Theme
            await loadScript(
                'https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/theme-monokai.js',
                './libs/theme-monokai.js'
            );
            scriptsLoaded.aceTheme = true;
            updateLoadingProgress(100);

            Logger.success('All dependencies loaded');
            return true;
        } catch (error) {
            Logger.error('Failed to load dependencies', error);
            alert('Failed to load required libraries. Please check your connection and try again.');
            return false;
        }
    }

    function updateLoadingProgress(percent) {
        if (loadingProgressBar) {
            loadingProgressBar.style.width = `${percent}%`;
        }
    }

    function waitForAce() {
        return new Promise((resolve) => {
            const checkAce = setInterval(() => {
                if (typeof ace !== 'undefined') {
                    clearInterval(checkAce);
                    resolve();
                }
            }, 50);
        });
    }

    // ==================== DEMO FILE MANAGEMENT - FIXED ====================

    demoSelect.addEventListener('change', async (e) => {
        const selectedDemo = e.target.value;
        
        // Check if clicking the same demo that's already loaded
        if (selectedDemo === lastLoadedDemo) {
            Logger.info(`Reloading ${selectedDemo} demo (force refresh)`);
            await loadDemoFile(selectedDemo, true); // Force reload
        } else {
            currentDemo = selectedDemo;
            await loadDemoFile(selectedDemo, false);
        }
    });

    async function loadDemoFile(demoKey, forceReload = false) {
        if (!editor) return;
        
        const demoUrl = DEMO_FILES[demoKey];
        if (!demoUrl) {
            Logger.error(`Demo file not found: ${demoKey}`);
            return;
        }
        
        try {
            Logger.info(`Loading ${demoKey} demo from Blob storage...${forceReload ? ' (force reload)' : ''}`);
            
            // Add cache buster for force reload
            const cacheBuster = forceReload ? `?t=${Date.now()}` : '';
            const response = await fetch(demoUrl + cacheBuster);
            
            if (response.ok) {
                const code = await response.text();
                editor.setValue('', -1);
                await new Promise(resolve => setTimeout(resolve, 50));
                editor.setValue(code, -1);
                editor.clearSelection();
                editor.moveCursorTo(0, 0);
                
                // Update last loaded demo
                lastLoadedDemo = demoKey;
                currentDemo = demoKey;
                
                // Clear saved code when loading a demo
                localStorage.removeItem("tc_code");
                
                updateEditorInfo();
                updateSaveIndicator();
                
                Logger.success(`Loaded ${demoKey} demo from Blob storage`);
            } else {
                Logger.error(`Failed to load demo: ${response.status}`);
                alert('Failed to load demo file. Please try again.');
            }
        } catch(e) {
            Logger.error('Error loading demo file', e);
            alert('Error loading demo file. Please check your connection.');
        }
    }

    // ==================== EDITOR INITIALIZATION ====================

    async function initializeEditor() {
        if (!scriptsLoaded.ace || typeof ace === 'undefined') {
            setTimeout(initializeEditor, 100);
            return;
        }

        editor = ace.edit("editor");
        
        editor.setTheme("ace/theme/monokai");
        editor.session.setMode("ace/mode/c_cpp");
        
        editor.setShowPrintMargin(false);
        editor.setOptions({
            enableBasicAutocompletion: true,
            enableLiveAutocompletion: true,
            fontSize: "14px",
            fontFamily: "'Consolas', 'Monaco', 'Courier New', monospace",
            highlightActiveLine: true,
            showGutter: true,
            tabSize: 4,
            useSoftTabs: true,
            wrap: true
        });

        await loadDefaultCode();

        editor.on('change', () => {
            updateEditorInfo();
            updateSaveIndicator();
        });

        setTimeout(() => {
            editor.focus();
            editorWrapper.classList.add('active');
        }, 100);

        Logger.success('Editor ready');
    }

    function updateEditorInfo() {
        if (!editor || !editorInfo) return;
        
        const code = editor.getValue();
        const lines = code.split('\n').length;
        const chars = code.length;
        
        editorInfo.textContent = `Lines: ${lines} | Chars: ${chars}`;
    }

    async function loadDefaultCode() {
        const savedCode = localStorage.getItem("tc_code");
        if (savedCode) {
            editor.setValue(savedCode, -1);
            updateEditorInfo();
            updateSaveIndicator();
            Logger.info('Restored saved code');
            return;
        }
        
        // Load default demo (circle-pattern)
        await loadDemoFile('circle-pattern', false);
    }

    // Clear button functionality
    clearBtn.addEventListener('click', () => {
        if (confirm('Are you sure you want to clear the editor?')) {
            editor.setValue('', -1);
            localStorage.removeItem("tc_code");
            lastLoadedDemo = ''; // Reset last loaded demo
            updateEditorInfo();
            updateSaveIndicator();
            Logger.info('Editor cleared');
        }
    });

    // ==================== FULLSCREEN FUNCTIONALITY - FIXED ====================
    
    let isEditorFullscreen = false;
    let isTerminalFullscreen = false;

    document.getElementById('fullscreen-editor-btn').addEventListener('click', () => {
        isEditorFullscreen = !isEditorFullscreen;
        
        if (isEditorFullscreen) {
            editorWrapper.classList.add('fullscreen');
            terminalWrapper.classList.add('hidden');
        } else {
            editorWrapper.classList.remove('fullscreen');
            terminalWrapper.classList.remove('hidden');
        }
        
        // Force editor resize after fullscreen toggle
        setTimeout(() => {
            if (editor) {
                editor.resize();
                editor.renderer.updateFull();
            }
        }, 100);
    });

    document.getElementById('fullscreen-terminal-btn').addEventListener('click', () => {
        isTerminalFullscreen = !isTerminalFullscreen;
        
        if (isTerminalFullscreen) {
            terminalWrapper.classList.add('fullscreen');
            editorWrapper.classList.add('hidden');
        } else {
            terminalWrapper.classList.remove('fullscreen');
            editorWrapper.classList.remove('hidden');
        }
        
        // Force canvas resize after fullscreen toggle
        setTimeout(() => {
            if (dosInstance) {
                // Trigger canvas resize
                window.dispatchEvent(new Event('resize'));
            }
        }, 100);
    });

    // ==================== KEYBOARD INPUT ISOLATION ====================
    
    let keyboardEventBlocker = null;

    function setupKeyboardBlocker() {
        keyboardEventBlocker = function(e) {
            if (!terminalFocused) {
                e.stopPropagation();
                e.stopImmediatePropagation();
                return false;
            }
        };

        window.addEventListener('keydown', keyboardEventBlocker, true);
        window.addEventListener('keyup', keyboardEventBlocker, true);
        window.addEventListener('keypress', keyboardEventBlocker, true);
    }

    // ==================== FOCUS MANAGEMENT ====================
    
    function focusTerminal() {
        if (!dosInstance) return;
        
        terminalFocused = true;
        canvas.focus();
        canvas.tabIndex = 1;
        terminalWrapper.classList.add('terminal-active');
        editorWrapper.classList.remove('active');
        keyboardBlocker.classList.remove('active');
    }

    function focusEditor() {
        if (!editor) return;
        
        terminalFocused = false;
        canvas.tabIndex = -1;
        canvas.blur();
        editor.focus();
        terminalWrapper.classList.remove('terminal-active');
        editorWrapper.classList.add('active');
        keyboardBlocker.classList.add('active');
    }

    keyboardBlocker.addEventListener('click', () => {
        focusTerminal();
    });

    terminalWrapper.addEventListener('click', (e) => {
        if (e.target === terminalWrapper || e.target === canvas) {
            if (dosInstance && !terminalFocused) {
                focusTerminal();
            }
        }
    });

    editorWrapper.addEventListener('click', () => {
        focusEditor();
    });

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            focusEditor();
            return false;
        }
    }, true);

    // ==================== RUN PROGRAM ====================
    
    async function runProgram() {
        if (!editor) {
            alert('Editor is still loading. Please wait...');
            return;
        }

        const code = editor.getValue();
        
        if (!code.trim()) {
            alert('Please write some code first!');
            return;
        }

        Logger.info('Starting compilation...');
        loading.classList.add('active');
        loadingText.textContent = 'Initializing DOS environment...';
        updateLoadingProgress(0);
        runBtn.disabled = true;
        runBtn.classList.add('loading');

        if (dosInstance) {
            try {
                dosInstance.exit();
            } catch(e) {
                Logger.warn('Error closing previous DOS instance');
            }
            dosInstance = null;
        }

        try {
            // Wait for Dos to be available
            if (!scriptsLoaded.jsdos || typeof Dos === 'undefined') {
                loadingText.textContent = 'Waiting for JS-DOS...';
                updateLoadingProgress(20);
                await new Promise((resolve) => {
                    const checkDos = setInterval(() => {
                        if (typeof Dos !== 'undefined') {
                            clearInterval(checkDos);
                            resolve();
                        }
                    }, 100);
                });
            }

            updateLoadingProgress(40);

            // Determine wdosbox URL with proper fallback
            let wdosboxUrl = './libs/wdosbox.js';
            let usingOnline = false;
            
            if (navigator.onLine) {
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 3000);
                    
                    const response = await fetch("https://js-dos.com/6.22/current/wdosbox.js", { 
                        method: 'HEAD',
                        cache: 'no-cache',
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (response.ok) {
                        wdosboxUrl = "https://js-dos.com/6.22/current/wdosbox.js";
                        usingOnline = true;
                    }
                } catch(e) {
                    Logger.info('Using local WDOSBOX due to network timeout');
                }
            }

            Logger.info(`Using ${usingOnline ? 'CDN' : 'local'} WDOSBOX`);
            updateLoadingProgress(60);

            Dos(canvas, {
                wdosboxUrl: wdosboxUrl,
                cycles: "max",
                autolock: false,
            }).ready(async (fs, main) => {
                
                loadingText.textContent = 'Downloading Turbo C++ from Blob storage...';
                updateLoadingProgress(70);
                
                try {
                    Logger.info('Fetching TC compiler from Vercel Blob Storage...');
                    
                    // Fetch the ZIP from Vercel Blob Storage
                    const tcResponse = await fetch(TC_ZIP_URL);
                    if (!tcResponse.ok) {
                        throw new Error(`Failed to download compiler (HTTP ${tcResponse.status})`);
                    }
                    
                    // Get as Blob
                    const tcBlob = await tcResponse.blob();
                    
                    // Create a temporary URL for the blob
                    const blobUrl = URL.createObjectURL(tcBlob);
                    
                    Logger.info('Extracting compiler files...');
                    loadingText.textContent = 'Extracting compiler files...';
                    
                    // Now extract from the blob URL - js-dos can handle blob: URLs
                    await fs.extract(blobUrl);
                    
                    // Clean up the blob URL
                    URL.revokeObjectURL(blobUrl);
                    
                    Logger.success('Turbo C compiler loaded from Blob storage');
                } catch(e) {
                    Logger.error('Compiler extraction failed', e);
                    throw new Error('Failed to load compiler: ' + e.message);
                }

                loadingText.textContent = 'Writing source code...';
                updateLoadingProgress(80);
                fs.createFile("TURBOC3/BIN/USER.CPP", code);

                const batchScript = `@ECHO OFF
CD TURBOC3\\BIN
IF EXIST USER.EXE DEL USER.EXE
TCC -I..\\INCLUDE -L..\\LIB -n. USER.CPP ..\\LIB\\GRAPHICS.LIB > ERR.TXT
IF EXIST USER.EXE GOTO SUCCESS
CLS
ECHO ========================================
ECHO COMPILATION ERRORS:
ECHO ========================================
TYPE ERR.TXT
ECHO.
PAUSE
EXIT
:SUCCESS
CLS
USER.EXE
PAUSE
`;

                fs.createFile("AUTOEXEC.BAT", batchScript);

                loadingText.textContent = 'Starting program...';
                updateLoadingProgress(90);
                
                dosInstance = await main(["-conf", "dosbox.conf", "AUTOEXEC.BAT"]);
                
                setupKeyboardBlocker();
                
                updateLoadingProgress(100);
                loading.classList.remove('active');
                runBtn.disabled = false;
                runBtn.classList.remove('loading');
                headerStatus.classList.add('active');
                headerStatus.querySelector('.status-text').textContent = 'Running';
                
                Logger.success('Program started successfully');
                
                setTimeout(() => {
                    focusTerminal();
                }, 500);
            });
            
        } catch (error) {
            Logger.error('Failed to start DOS environment', error);
            alert('Failed to start DOS environment. Error: ' + error.message);
            loading.classList.remove('active');
            runBtn.disabled = false;
            runBtn.classList.remove('loading');
            updateLoadingProgress(0);
        }
    }

    // ==================== KEYBOARD SHORTCUTS ====================
    
    window.addEventListener('keydown', (e) => {
        // Ctrl/Cmd + Enter to run
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter' && !terminalFocused) {
            e.preventDefault();
            runProgram();
        }
        
        // Ctrl/Cmd + S to save
        if ((e.ctrlKey || e.metaKey) && e.key === 's' && !terminalFocused) {
            e.preventDefault();
            saveCode();
        }
    });

    // ==================== RESPONSIVE HANDLING ====================
    
    function handleResize() {
        if (editor) {
            editor.resize();
            editor.renderer.updateFull();
        }
    }

    window.addEventListener('resize', handleResize);
    window.addEventListener('orientationchange', () => {
        setTimeout(handleResize, 300);
    });

    // ==================== INITIALIZATION ====================
    
    (async function init() {
        Logger.info('Initializing compiler...');
        updateConnectionStatus();
        updateSaveIndicator();
        
        const loaded = await loadAllScripts();
        if (loaded) {
            await initializeEditor();
            Logger.success('Compiler ready');
        }
    })();

</script>

</body>
</html>